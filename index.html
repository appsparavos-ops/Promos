<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>üçî Raspadita de Octubre üçî - AZ Burger</title>
<style>
  /* Asegurar que html y body ocupen toda la pantalla y no permitan scroll en m√≥viles */
  html, body { height: 100%; overscroll-behavior-y: none; }
  body { -webkit-touch-callout: none; -webkit-user-select: none; -ms-user-select: none; user-select: none; }
  body {
    background: #000;
    color: #fff;
    font-family: Arial, sans-serif;
    text-align: center;
    overflow: hidden; /* Evita el scroll en la p√°gina */
    margin: 0;
    padding: 0;
    touch-action: manipulation;
  }
  h1 { color: #e74c3c; }
  .muted { font-size: 13px; color: #aaa; }
  .scratch-wrap { 
    position: relative; 
    width: 300px; 
    height: 300px; 
    margin: auto; 
    border: 2px solid rgb(89, 89, 87);
    pointer-events: auto; /* Permitir eventos sobre el contenedor (controlado por JS) */
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
  }
  #prizeBox { 
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    display: flex; align-items: center; justify-content: center; 
    background: #111; color: gold; font-weight: bold; 
  }
  canvas { position: absolute; top:0; left:0; touch-action: none; }

  /* Asegurar que la capa con el texto del premio no intercepte eventos del canvas */
  #prizeBox { pointer-events: none; }
  canvas { pointer-events: auto; }

  .modal {
    display: flex; 
    position: fixed; 
    z-index: 9999; 
    left: 0;
    top: 0;
    width: 100vw; 
    height: 100vh; 
    overflow: hidden; 
    background-color: rgba(0,0,0,0.85); 
    justify-content: center;
    align-items: center;
    -webkit-backdrop-filter: blur(4px);
    backdrop-filter: blur(4px);
  }

  .modal-content {
    background-color: #333;
    padding: 14px;
    border: 1px solid #888;
    width: 80%;
    max-width: 600px;
    border-radius: 12px;
    text-align: center;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  #userForm input {
    width: calc(100% - 22px);
    padding: 10px;
    margin: 10px 0;
    border-radius: 5px;
    border: 1px solid #555;
    background-color: #222;
    color: #fff;
  }

  #userForm button {
    background-color: #e74c3c;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
  }
  #secondAttemptBtn {
      background-color: #e74c3c;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
      margin-left: auto;
      margin-right: auto;
      display: none;
  }

  #goodbyeMessage {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
    opacity: 0;
    transition: opacity 1s ease-in-out;
    pointer-events: none;
  }

  #goodbyeMessage p {
    color: white;
    font-size: 1vw;
    transform: scale(0.1);
    transition: all 1.5s ease-out;
  }

  @media screen and (max-width: 600px) {
    /* Modal grande y centrado, sin scroll */
    .modal-content {
      width: 98vw;
      height: 98vh; /* Ocupa casi toda la pantalla */
      max-width: 98vw;
      max-height: 98vh;
      border-radius: 8px;
      padding: 8px;
    }

    /* Centrar main content y hacerlo full-screen */
    #mainContent {
      height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
      padding: 8px;
    }

    /* Hacer la raspadita tan grande como quepa en pantalla (cuadrada) */
    .scratch-wrap {
      width: 90vw; /* Ancho relativo a la pantalla */
      height: 90vw; /* Mantener proporci√≥n cuadrada */
      max-width: 96vh; /* asegurar que entre en altura */
      max-height: 96vh;
      border-radius: 8px;
      overflow: hidden;
    }

    #scratchCanvas {
      width: 100%;
      height: 100%;
    }

    /* Mensaje de despedida grande y centrado */
    #goodbyeMessage {
      display: flex !important;
      align-items: center;
      justify-content: center;
      width: 100vw;
      height: 100vh;
      top: 0;
      left: 0;
      padding: 0;
    }

    #goodbyeMessage p {
      font-size: 12vw; /* Muy grande */
      text-align: center;
      margin: 0;
      transform: scale(1);
    }

    /* Reducir tama√±o del t√≠tulo en vista m√≥vil para dejar m√°s espacio a la raspadita */
    h1 {
      font-size: 6vw;
      margin: 6px 0 8px 0;
      line-height: 1.05;
    }
  }
</style>
</head>
<body>

  <div id="welcomeModal" class="modal">
    <div class="modal-content">
      <h2>Bienvenido a la Raspadita de AZ Burger</h2>
      <p>Por favor, reg√≠strate para jugar.</p>
      <form id="userForm">
        <input type="text" id="userName" placeholder="Nombre y Apellido" required>
  <input type="tel" id="userPhone" placeholder="N√∫mero de Tel√©fono (9 d√≠gitos)" required inputmode="numeric" pattern="\d{9}" minlength="9" maxlength="9" title="Ingrese 9 d√≠gitos" />
        <button type="submit">Jugar</button>
      </form>
    </div>
  </div>

  <div id="mainContent" style="display: none;">
    <h1>üçî Raspadita de Octubre üçî</h1>
    <p>Sigue a <b>@azburgerhouse</b> en Instagram para jugar</p>
    <div id="scratchContainer" class="scratch-wrap">
      <div id="prizeBox"><div id="prizeText">Cargando...</div></div>
      <canvas id="scratchCanvas" width="300" height="300"></canvas>
    </div>

    <p>üëÜ Raspa el Logo üëÜ</p>
    <button id="secondAttemptBtn">Jugar 2do Intento</button>
    <p id="result"></p>
    <footer>
      <p class="muted">Si no sigues la p√°gina no tendr√°s derecho a reclamar el premio.</p>
      <p class="muted">Premios v√°lidos hasta el 31/10.</p>
      <p class="muted">No acumulables con otras promociones</p>
    </footer>
  </div>

  <div id="goodbyeMessage" style="display: none;">
    <p>Gracias por participar</p>
  </div>

<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-database-compat.js"></script>
<script>
  // Configuraci√≥n de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDBExMYiIefz4OXCZ7pLF6vy0sfZp7ergo",
    authDomain: "azburguer-c512b.firebaseapp.com",
    databaseURL: "https://azburguer-c512b-default-rtdb.firebaseio.com",
    projectId: "azburguer-c512b",
    storageBucket: "azburguer-c512b.firebasestorage.app",
    messagingSenderId: "444971647817",
    appId: "1:444971647817:web:8ee7528ab7559c71b1d098",
    measurementId: "G-YQFPY123JR"
  };

  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  let currentUser = null;
  let isSecondAttempt = false;
  const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

  const modal = document.getElementById('welcomeModal');
  const userForm = document.getElementById('userForm');
  const userNameInput = document.getElementById('userName');
  const userPhoneInput = document.getElementById('userPhone');
  const scratchContainer = document.getElementById('scratchContainer');
  const secondAttemptBtn = document.getElementById('secondAttemptBtn');

  window.addEventListener('DOMContentLoaded', () => {
    modal.style.display = 'flex';
  });

  userForm.addEventListener('submit', (e) => {
    e.preventDefault();
    // Obtener y sanitizar el tel√©fono: solo d√≠gitos
    let phone = (userPhoneInput.value || '').toString();
    const name = (userNameInput.value || '').toString().trim();
    phone = phone.replace(/\D/g, ''); // quitar espacios, guiones, par√©ntesis

    if (!phone || !name) {
      alert('Por favor, completa todos los campos.');
      return;
    }

    if (phone.length !== 9) {
      alert('Ingrese un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos (solo n√∫meros).');
      return;
    }

    // Guardar en la nueva ruta clientes/{telefono}
    const clienteRef = database.ref('clientes/' + phone);
    clienteRef.set({
      nombre: name,
      telefono: phone
    });

    const userRef = database.ref('users/' + phone);
    userRef.once('value').then((snapshot) => {
        if (snapshot.exists()) {
        currentUser = snapshot.val();
        // Bloquear si ya agot√≥ intentos o si gan√≥ en la primera tirada
        const wonFirst = currentUser.attempt1_result && currentUser.attempt1_result.indexOf('üéÅ') !== -1;
        if (currentUser.attempts >= 2 || wonFirst) {
          alert('Este n√∫mero de tel√©fono ya ha participado y no puede jugar de nuevo.');
        } else {
          modal.style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
          setTimeout(inicializarCanvas, 0);
          window.scrollTo(0, 0);
          // Si ya hizo un intento y no gan√≥, mostrar segundo intento; en otro caso permitir raspar
          if (currentUser.attempts === 1) {
            secondAttemptBtn.style.display = 'block';
            scratchContainer.style.pointerEvents = 'none';
          } else {
            scratchContainer.style.pointerEvents = 'auto';
          }
        }
      } else {
        currentUser = {
          name: name,
          phone: phone,
          attempts: 0,
          attempt1_result: null,
          attempt2_result: null
        };
        userRef.set(currentUser).then(() => {
          modal.style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
          setTimeout(inicializarCanvas, 0);
          scratchContainer.style.pointerEvents = 'auto';
        });
      }
    });
  });
  
  secondAttemptBtn.addEventListener('click', () => {
    revealed = false;
    isSecondAttempt = true;
    resetCanvas();
    prizeText.textContent = 'Gira el movil para activar';
    scratchContainer.style.pointerEvents = 'auto';
    secondAttemptBtn.style.display = 'none';
    result.textContent = '';
  });

  function weightedPick(){
    const r = Math.random()*100;
    if(r < 60) return 'participa';
    if(r < 90) return '5';
    return '10';
  }

  const canvas = document.getElementById('scratchCanvas');
  const ctx = canvas.getContext('2d');
  const prizeText = document.getElementById('prizeText');
  const result = document.getElementById('result');
  
  const img = new Image();
  let canvasInitialized = false;

  function inicializarCanvas() {
    if (canvasInitialized) return;
    canvasInitialized = true;
    prizeText.textContent = 'Gira el movil para activar';
    resetCanvas();
    window.addEventListener('resize', resetCanvas);
  }

  img.onload = () => {
      console.log('imagen cargada:', img.src);
      if (canvasInitialized) {
        resetCanvas();
      }
  };
  img.src = 'logo.png';

  function resetCanvas(){
    console.log('resetCanvas: ajustando canvas a contenedor');
    const container = document.querySelector('.scratch-wrap');
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
    ctx.globalCompositeOperation='source-over';
    // Dibujar imagen del logo si ya est√° cargada; si no, pintar un fondo neutro
    if (img && img.complete && img.naturalWidth > 0) {
      try {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      } catch (err) {
        console.warn('drawImage fall√≥:', err);
        ctx.fillStyle = '#333';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    } else {
      console.warn('resetCanvas: imagen no disponible, usando fondo neutro');
      ctx.fillStyle = '#333';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
  }

  let drawing=false;
  let revealed = false;

  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    let event = e.touches ? e.touches[0] : e;

    // Use scaling for mobile to handle responsive vw units, but not for PC.
    if (isMobile) {
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
            x: (event.clientX - rect.left) * scaleX,
            y: (event.clientY - rect.top) * scaleY
        };
    } else {
        return {
            x: (event.clientX - rect.left),
            y: (event.clientY - rect.top)
        };
    }
  }

  function erase(x,y){
    ctx.globalCompositeOperation='destination-out';
    ctx.beginPath();
    ctx.arc(x,y,20,0,Math.PI*2);
    ctx.fill();
    // Chequear si ya se revel√≥ suficiente √°rea tras cada borrado
    checkReveal();
  }

  function showGoodbyeMessage(passedPrize = '') {
    document.getElementById('mainContent').style.display = 'none';
    const goodbyeDiv = document.getElementById('goodbyeMessage');

    // Construir contenido: mensaje grande + (opcional) premio
    const prize = passedPrize || ((typeof prizeText !== 'undefined' && prizeText) ? prizeText.textContent.trim() : '');
    const hasPrize = prize.includes('üéÅ');

    // Limpiar y crear elementos
    goodbyeDiv.innerHTML = '';
    if (hasPrize) {
      // Solo mostrar el premio ganado
  const prizeP = document.createElement('p');
  prizeP.textContent = prize;
  prizeP.style.color = 'gold';
  prizeP.style.marginTop = '1rem';
  // Mostrar el premio 3 veces m√°s grande
  prizeP.style.fontSize = '21vw';
      goodbyeDiv.appendChild(prizeP);
      // animaci√≥n para el premio
      setTimeout(() => {
        goodbyeDiv.style.display = 'flex';
        goodbyeDiv.style.pointerEvents = 'auto';
        goodbyeDiv.style.opacity = '1';
      }, 100);
    } else {
      const bigP = document.createElement('p');
      bigP.textContent = 'Gracias por participar';
      goodbyeDiv.appendChild(bigP);
      goodbyeDiv.style.display = 'flex';
      goodbyeDiv.style.pointerEvents = 'auto';
      setTimeout(() => {
        goodbyeDiv.style.opacity = '1';
        bigP.style.transform = 'scale(1)';
        bigP.style.fontSize = '8vw';
      }, 100);
    }
  }

  function checkReveal(){
    if(revealed) return;
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height).data;
    let transparent=0;
    for(let i=3;i<imgData.length;i+=4) if(imgData[i]<128) transparent++;
  if(transparent > canvas.width*canvas.height*0.35) {
        revealed = true;
        finalizePrize();
    }
  }

  function finalizePrize(){
    const pick = weightedPick();
    console.log('finalizePrize: pick=', pick, 'isSecondAttempt=', isSecondAttempt, 'currentUser attempts=', currentUser && currentUser.attempts);
    let prize = '‚ùå Segu√≠ participando';

    // Si el pick sugiere un premio, intentamos reservar uno de forma at√≥mica en /prizes
    if (pick === '5' || pick === '10') {
      const prizesRef = database.ref('prizes');
      // Usamos transaction para evitar condiciones de carrera entre clientes
      prizesRef.transaction(prizes => {
        if (!prizes) return prizes; // nada que hacer
        const counts = prizes.counts || {};
        const codes5 = prizes.codes_5 || [];
        const codes10 = prizes.codes_10 || [];
        console.log('prizes transaction: counts=', counts, 'codes5_len=', codes5.length, 'codes10_len=', codes10.length);

        if (pick === '5' && counts.rem5 > 0 && codes5.length > 0) {
          // asignar el primer c√≥digo disponible
          const code = codes5.shift();
          counts.rem5 = Math.max(0, counts.rem5 - 1);
          prizes.codes_5 = codes5;
          prizes.counts = counts;
          prizes._last_assigned = {type: '5', code: code};
          prize = 'üéÅ 5% OFF ‚Äì C√≥digo: ' + code;
          console.log('Asignando 5% OFF, codigo=', code);
        } else if (pick === '10' && counts.rem10 > 0 && codes10.length > 0) {
          const code = codes10.shift();
          counts.rem10 = Math.max(0, counts.rem10 - 1);
          prizes.codes_10 = codes10;
          prizes.counts = counts;
          prizes._last_assigned = {type: '10', code: code};
          prize = 'üéÅ 10% OFF ‚Äì C√≥digo: ' + code;
          console.log('Asignando 10% OFF, codigo=', code);
        } else {
          // No hay c√≥digos disponibles para el tipo seleccionado
          console.log('No hay c√≥digos disponibles para pick=', pick, 'counts=', counts);
          prize = '‚ùå Segu√≠ participando';
        }
        return prizes;
      }).then(() => {
        console.log('transaction.then: prize=', prize);
        // Despu√©s de la transacci√≥n, actualizamos UI y guardamos en el registro del usuario
        prizeText.textContent = prize;
        if (prize.startsWith('üéÅ')) {
          result.textContent = 'V√°lido hasta 31/10. Mostrar en local para canjear.';
        }

        // Guardar en Firebase - registro del usuario
        if(currentUser){
          const attemptField = isSecondAttempt ? 'attempt2_result' : 'attempt1_result';
          const updates = {};
          const attemptsAfter = currentUser.attempts + 1;
          updates['/users/' + currentUser.phone + '/attempts'] = attemptsAfter;
          updates['/users/' + currentUser.phone + '/' + attemptField] = prize;
          database.ref().update(updates);

          // Si hay premio (incluye c√≥digo), registrar ganador globalmente
          if (prize.startsWith('üéÅ')) {
            // extraer c√≥digo despu√©s de 'C√≥digo: '
            const parts = prize.split('C√≥digo:');
            const code = parts.length > 1 ? parts[1].trim() : '';
            if (code) {
              const winnerRef = database.ref('winners');
              winnerRef.push({ phone: currentUser.phone, code: code, prize: prize, ts: Date.now() });
            }
          }

          const wasFirstAttempt = currentUser.attempts === 0;
          currentUser.attempts = attemptsAfter;

          const wonPrize = prize.startsWith('üéÅ');

          if (wasFirstAttempt && wonPrize) {
            // Si gan√≥ en la primera tirada, finalizar juego: no 2do intento y mostrar goodbye/prize
            secondAttemptBtn.style.display = 'none';
            scratchContainer.style.pointerEvents = 'none';
            setTimeout(() => showGoodbyeMessage(prize), 4000);
          } else if (currentUser.attempts < 2) {
            // A√∫n tiene intento disponible
            secondAttemptBtn.style.display = 'block';
            // permitir raspado si corresponde
            scratchContainer.style.pointerEvents = 'auto';
          } else {
            // Juego finalizado (no quedan intentos)
            // Juego finalizado: ocultar bot√≥n y mostrar overlay con premio (si hay) o mensaje de gracias
            secondAttemptBtn.style.display = 'none';
            scratchContainer.style.pointerEvents = 'none';
            setTimeout(() => showGoodbyeMessage(prize), 4000);
          }
          // Restablecer flag de segundo intento para futuras interacciones
          isSecondAttempt = false;
        }
      }).catch(err => {
        console.error('Transaction error:', err);
        prizeText.textContent = '‚ùå Segu√≠ participando';
      });
      return; // salimos, la actualizaci√≥n de user est√° dentro del then()
    }

    // Si pick === 'participa' o no se asign√≥ c√≥digo, simplemente mostrar y guardar
    prizeText.textContent = prize;
    if(currentUser){
      const attemptField = isSecondAttempt ? 'attempt2_result' : 'attempt1_result';
      const updates = {};
      const attemptsAfter = currentUser.attempts + 1;
      updates['/users/' + currentUser.phone + '/attempts'] = attemptsAfter;
      updates['/users/' + currentUser.phone + '/' + attemptField] = prize;
      database.ref().update(updates);

      // Registrar ganador si corresponde
      if (prize.startsWith('üéÅ')) {
        const parts = prize.split('C√≥digo:');
        const code = parts.length > 1 ? parts[1].trim() : '';
        if (code) {
          const winnerRef = database.ref('winners');
          winnerRef.push({ phone: currentUser.phone, code: code, prize: prize, ts: Date.now() });
        }
      }

      const wasFirstAttempt = currentUser.attempts === 0;
      currentUser.attempts = attemptsAfter;
      const wonPrize = prize.startsWith('üéÅ');
      if (wasFirstAttempt && wonPrize) {
        secondAttemptBtn.style.display = 'none';
        scratchContainer.style.pointerEvents = 'none';
  setTimeout(() => showGoodbyeMessage(prize), 4000);
      } else if(currentUser.attempts < 2){
        secondAttemptBtn.style.display = 'block';
        scratchContainer.style.pointerEvents = 'auto';
      } else {
        // Juego finalizado: ocultar bot√≥n y mostrar overlay con premio (si hay) o mensaje de gracias
        secondAttemptBtn.style.display = 'none';
        scratchContainer.style.pointerEvents = 'none';
        setTimeout(() => showGoodbyeMessage(prize), 4000);
      }
      // Restablecer flag de segundo intento para futuras interacciones
      isSecondAttempt = false;
    }
  }

  function startDrawing(e) {
    // Evitar comportamiento por defecto (scroll) en eventos t√°ctiles
    if (e && typeof e.preventDefault === 'function') e.preventDefault();
    console.log('startDrawing fired', e && e.type);
    drawing = true;
    // Al comenzar a raspar, si el texto est√° en el mensaje inicial, actualizarlo
    if (prizeText && prizeText.textContent && prizeText.textContent.trim() === 'Gira el movil para activar') {
      prizeText.textContent = 'Sigue raspando';
    }
    let p = getPos(e);
    erase(p.x,p.y);
  }

  function stopDrawing() {
    if (drawing) {
      console.log('stopDrawing fired');
      drawing = false;
      checkReveal();
    }
  }

  function draw(e) {
    if (e && typeof e.preventDefault === 'function') e.preventDefault();
    if (drawing) {
      console.log('draw', e && e.type);
      let p = getPos(e);
      erase(p.x,p.y);
    }
  }

  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('touchstart', startDrawing, { passive: false });
  canvas.addEventListener('touchend', stopDrawing, { passive: false });
  canvas.addEventListener('touchmove', draw, { passive: false });
  // Asegurar que soltar fuera del canvas tambi√©n detenga el dibujo
  window.addEventListener('mouseup', stopDrawing);
  window.addEventListener('touchend', stopDrawing, { passive: false });

</script>
</body>
</html>